<!doctype html><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content=ylxdzsw@gmail.com><meta charset=utf-8><title>One Set | ylxdzsw's blog</title><style>html{font-family:sans-serif;font-size:16px;line-height:1.5;text-align:justify;hyphens:auto;color:#33333d}@media (max-width:425px){html{font-size:15px}}body{max-width:625px;margin:0 auto;padding:1rem 1rem}@media (max-width:425px){body{padding:0 .8rem}}h3{margin:2rem 0 1rem;position:relative;border-bottom:#bbb 1px solid}label{display:block;font-weight:500;font-size:.9rem}label input:not([type]),label input[type=number],label input[type=text]{display:block;width:100%;margin:.1rem 0 1rem;padding:.4rem;border:1px solid #bbb;border-radius:3px;font-size:.9rem;box-sizing:border-box}label input[type=checkbox]{margin:.1rem .5rem 1rem 0;transform:translateY(.1rem)}button{display:inline-block;appearance:none;background-color:transparent;border:1px solid #bbb;border-radius:.375rem;cursor:pointer;line-height:100%;padding:.6rem .8rem}button:active{border-color:#4a4a4a;outline:0}button:focus{border-color:#485fc7;outline:0}button:hover{border-color:#b5b5b5}button:focus:not(:active){box-shadow:rgba(72,95,199,.25) 0 0 0 .125rem}pre{clear:both;margin-top:1rem;font-family:monospace;color:#222;border:1px solid #bcd;background-color:#ebf1f5;padding:.8rem;overflow-x:auto;font-size:.8rem}.hidden{opacity:0}</style><script>function gather_inputs(){const e=Object.create(null);for(const t of document.querySelectorAll("input"))switch(t.type){case"text":e[t.name]=t.value;break;case"number":e[t.name]=parseFloat(t.value);break;case"checkbox":e[t.name]=t.checked}return e}window.addEventListener("load",(async()=>{if(document.querySelector("button").addEventListener("click",(async()=>{document.querySelector("pre").classList.remove("hidden"),document.querySelector("button").disabled=!0,await new Promise((e=>setTimeout(e,0)));const e=gather_inputs();try{const t=await run(e);t&&(document.querySelector("pre").textContent=t)}catch(e){throw document.querySelector("pre").textContent="Error: "+(e.message??e),e}finally{document.querySelector("button").disabled=!1,await new Promise((e=>setTimeout(e,0)))}})),document.body.addEventListener("input",(()=>{const e=new URLSearchParams(gather_inputs());history.replaceState(null,"","#"+e.toString())})),location.hash.length>1){const e=new URLSearchParams(location.hash.slice(1));for(const[t,n]of e.entries()){const e=document.querySelector(`input[name="${t}"]`);if(e)switch(e.type){case"text":case"number":e.value=n;break;case"checkbox":e.checked="true"==n}}}}))</script><h3>One Set</h3><label>Comma-separated droprates of each item. e.g., fill 0.01,0.02 for two items whose droprates are 1% and 2%. Integer division like 1/70 is supported.<input name=droprates placeholder=0.01,1/200,0.02></label><label>Demands. Optional. Defaults to one for each item.<input name=demands placeholder=1,1,1></label> <label><input type=checkbox name=multidrop>One chest may drop multiple items</label><label><input type=checkbox name=fast_approximation>Fast approximation (binary search with the cdf of binomial distribution)</label><script>let progress_bar=null;async function run(args){const droprates=eval("["+args.droprates+"]").map(Number),demands=eval("["+args.demands+"]").map(Number),max_pull=args.fast_approximation?1e15:args.multidrop?1e6:5e4;for(const e of droprates)if(isNaN(e)||e<=0||e>1)throw"Invalid droprate";if(0==droprates.length)throw"No droprates";for(const e of demands)if(!Number.isInteger(e)||e<0)throw"Invalid demand";if(0==demands.length)for(;demands.length<droprates.length;)demands.push(1);else if(demands.length!=droprates.length)throw"Mismatched droprates and demands";if(!args.multidrop&&droprates.reduce(((e,t)=>e+t),0)>1)throw"Total droprate exceeds 100%";const checkpoints=[.5,.8,.9,.95,.99,.999,.9999],checkpoint_pulls=checkpoints.map((e=>null));if(args.fast_approximation){const e=await import("https://cdn.jsdelivr.net/gh/stdlib-js/stats-base-dists-binomial-cdf@esm/index.mjs"),t=e.default;e:for(let e=0;e<checkpoints.length;e++){let r=demands.reduce(((e,t)=>Math.max(e,t)),0),o=2*r;for(;fast_approximation_probability(o,droprates,demands,t)<checkpoints[e];)if(o*=2,o>=max_pull)break e;for(;o>r+1;){const n=Math.floor(r/2+o/2);fast_approximation_probability(n,droprates,demands,t)<checkpoints[e]?r=n:o=n}checkpoint_pulls[e]=o}}else{const e=args.multidrop?multi_drop_probability:single_drop_probability,t=args.multidrop?[]:{};let r=0;e:for(let o=1;o<=max_pull;o++){const n=e(o,droprates,demands,t);for(o%Math.floor(max_pull/100)==0&&(progress_bar||(progress_bar=document.createElement("progress"),progress_bar.max=1,progress_bar.style.marginLeft="1em",document.body.insertBefore(progress_bar,document.querySelector("pre"))),progress_bar.value=Math.max(n,o/max_pull),await new Promise((e=>setTimeout(e,0))));n>checkpoints[r];)if(checkpoint_pulls[r]=o,r+=1,r>=checkpoints.length)break e}}let result="undefined"!=typeof Deno||document.title.includes("One Set")?"Prob.\t#Chests\n":"集齐概率\t抽卡次数\n";for(let e=0;e<checkpoints.length;e++)result+=checkpoints[e]+"\t"+(checkpoint_pulls[e]??`>${max_pull}`)+"\n";return progress_bar&&progress_bar.remove(),progress_bar=null,result}function single_drop_probability(e,t,r,o){if(r.every((e=>e<=0)))return 1;if(e<=0)return 0;const n=e+","+r.join(",");if(n in o)return o[n];let a=0,s=0;for(let n=0;n<t.length;n++){if(r[n]<=0)continue;const i=r.slice();i[n]-=1,s+=t[n]*single_drop_probability(e-1,t,i,o),a+=t[n]}return s+=(1-a)*single_drop_probability(e-1,t,r,o),o[n]=s}function multi_drop_probability(e,t,r,o){function n(e,t,r,o){if(t<=0)return 1;if(e<=0)return 0;const a=e+","+t;return a in o?o[a]:o[a]=r*n(e-1,t-1,r,o)+(1-r)*n(e-1,t,r,o)}for(;o.length<t.length;)o.push({});let a=1;for(let s=0;s<t.length;s++)a*=n(e,r[s],t[s],o[s]);return a}function fast_approximation_probability(e,t,r,o){let n=1;for(let a=0;a<t.length;a++)r[a]>0&&(n*=1-o(r[a]-1,e,t[a]));return n}"undefined"!=typeof Deno?run({droprates:"0.5,0.1,0.1",demands:"2,2,1",multidrop:!0,fast_approximation:!0}).then(console.log):(document.querySelector('input[name="fast_approximation"]').addEventListener("change",(e=>{e.target.checked&&(document.querySelector('input[name="multidrop"]').checked=!0)})),document.querySelector('input[name="multidrop"]').addEventListener("change",(e=>{e.target.checked||(document.querySelector('input[name="fast_approximation"]').checked=!1)})))</script><button>Run</button><pre class=hidden></pre>