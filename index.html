<!doctype html><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content=ylxdzsw@gmail.com><meta charset=utf-8><title>集齐一套 | ylxdzsw's blog</title><style>html{font-family:sans-serif;font-size:16px;line-height:1.5;text-align:justify;hyphens:auto;color:#33333d}@media (max-width:425px){html{font-size:15px}}body{max-width:625px;margin:0 auto;padding:1rem 1rem}@media (max-width:425px){body{padding:0 .8rem}}h3{margin:2rem 0 1rem;position:relative;border-bottom:#bbb 1px solid}label{display:block;font-weight:500;font-size:.9rem}label input:not([type]),label input[type=number],label input[type=text]{display:block;width:100%;margin:.1rem 0 1rem;padding:.4rem;border:1px solid #bbb;border-radius:3px;font-size:.9rem;box-sizing:border-box}label input[type=checkbox]{margin:.1rem .5rem 1rem 0;transform:translateY(.1rem)}button{display:inline-block;appearance:none;background-color:transparent;border:1px solid #bbb;border-radius:.375rem;cursor:pointer;line-height:100%;padding:.6rem .8rem}button:active{border-color:#4a4a4a;outline:0}button:focus{border-color:#485fc7;outline:0}button:hover{border-color:#b5b5b5}button:focus:not(:active){box-shadow:rgba(72,95,199,.25) 0 0 0 .125rem}pre{clear:both;margin-top:1rem;font-family:monospace;color:#222;border:1px solid #bcd;background-color:#ebf1f5;padding:.8rem;overflow-x:auto;font-size:.8rem}.hidden{opacity:0}</style><script>function gather_inputs(){const e=Object.create(null);for(const t of document.querySelectorAll("input"))switch(t.type){case"text":e[t.name]=t.value;break;case"number":e[t.name]=parseFloat(t.value);break;case"checkbox":e[t.name]=t.checked}return e}window.addEventListener("load",(async()=>{if(document.querySelector("button").addEventListener("click",(async()=>{document.querySelector("pre").classList.remove("hidden"),document.querySelector("button").disabled=!0,await new Promise((e=>setTimeout(e,0)));const e=gather_inputs();try{const t=await run(e);t&&(document.querySelector("pre").textContent=t)}catch(e){throw document.querySelector("pre").textContent="Error: "+(e.message??e),e}finally{document.querySelector("button").disabled=!1,await new Promise((e=>setTimeout(e,0)))}})),document.querySelectorAll("input").forEach((e=>{e.addEventListener("input",(()=>{const e=new URLSearchParams(gather_inputs());history.replaceState(null,"","#"+e.toString())}))})),location.hash.length>1){const e=new URLSearchParams(location.hash.slice(1));for(const[t,n]of e.entries()){const e=document.querySelector(`input[name="${t}"]`);if(e)switch(e.type){case"text":case"number":e.value=n;break;case"checkbox":e.checked="true"==n}}}}))</script><h3>集齐一套</h3><label>英文逗号分隔每样物品掉率，例如1%就填0.01，可以写整数除法例如1/70。<input name=droprates placeholder=0.01,1/200,0.02></label><label>每样物品需求量。选填，默认全为1。<input name=demands placeholder=1,1,1></label> <label><input type=checkbox name=multidrop>单次抽卡可以同时出多样物品</label><label><input type=checkbox name=fast_approximation>快速估算（二分搜索 inf{x ∈ ℝ: p ≤ I₁₋ₓ(n - k, 1 + k)}）</label><script>let progress_bar=null;async function run(args){const droprates=eval("["+args.droprates+"]").map(Number),demands=eval("["+args.demands+"]").map(Number),max_pull=args.fast_approximation?1e15:args.multidrop?1e6:5e4;for(const e of droprates)if(isNaN(e)||e<=0||e>1)throw"Invalid droprate";if(0==droprates.length)throw"No droprates";for(const e of demands)if(!Number.isInteger(e)||e<0)throw"Invalid demand";if(0==demands.length)for(;demands.length<droprates.length;)demands.push(1);else if(demands.length!=droprates.length)throw"Mismatched droprates and demands";if(!args.multidrop&&droprates.reduce(((e,r)=>e+r),0)>1)throw"Total droprate exceeds 100%";const checkpoints=[.5,.8,.9,.95,.99,.999,.9999],checkpoint_pulls=checkpoints.map((e=>null));if(args.fast_approximation){const e=await import("https://cdn.jsdelivr.net/gh/stdlib-js/stats-base-dists-binomial-cdf@esm/index.mjs"),r=e.default;e:for(let e=0;e<checkpoints.length;e++){let t=demands.reduce(((e,r)=>Math.max(e,r)),0),o=2*t;for(;fast_approximation_probability(o,droprates,demands,r)<checkpoints[e];)if(o*=2,o>=max_pull)break e;for(;o>t+1;){const n=Math.floor(t/2+o/2);fast_approximation_probability(n,droprates,demands,r)<checkpoints[e]?t=n:o=n}checkpoint_pulls[e]=o}}else{const e=args.multidrop?multi_drop_probability:single_drop_probability,r=args.multidrop?[]:{};let t=0;e:for(let o=1;o<=max_pull;o++){const n=e(o,droprates,demands,r);for(o%Math.floor(max_pull/100)==0&&(progress_bar||(progress_bar=document.createElement("progress"),progress_bar.max=1,progress_bar.style.marginLeft="1em",document.body.insertBefore(progress_bar,document.querySelector("pre"))),progress_bar.value=Math.max(n,o/max_pull),await new Promise((e=>setTimeout(e,0))));n>checkpoints[t];)if(checkpoint_pulls[t]=o,t+=1,t>=checkpoints.length)break e}}let result="集齐概率\t抽卡次数\n";for(let e=0;e<checkpoints.length;e++)result+=checkpoints[e]+"\t"+(checkpoint_pulls[e]??`>${max_pull}`)+"\n";return progress_bar&&progress_bar.remove(),progress_bar=null,result}function single_drop_probability(e,r,t,o){if(t.every((e=>e<=0)))return 1;if(e<=0)return 0;const n=e+","+t.join(",");if(n in o)return o[n];let a=0,s=0;for(let n=0;n<r.length;n++){if(t[n]<=0)continue;const i=t.slice();i[n]-=1,s+=r[n]*single_drop_probability(e-1,r,i,o),a+=r[n]}return s+=(1-a)*single_drop_probability(e-1,r,t,o),o[n]=s}function multi_drop_probability(e,r,t,o){function n(e,r,t,o){if(r<=0)return 1;if(e<=0)return 0;const a=e+","+r;return a in o?o[a]:o[a]=t*n(e-1,r-1,t,o)+(1-t)*n(e-1,r,t,o)}for(;o.length<r.length;)o.push({});let a=1;for(let s=0;s<r.length;s++)a*=n(e,t[s],r[s],o[s]);return a}function fast_approximation_probability(e,r,t,o){let n=1;for(let a=0;a<r.length;a++)t[a]>0&&(n*=1-o(t[a]-1,e,r[a]));return n}"undefined"!=typeof Deno?run({droprates:"0.5,0.1,0.1",demands:"2,2,1",multidrop:!0,fast_approximation:!0}).then(console.log):(document.querySelector('input[name="fast_approximation"]').addEventListener("change",(e=>{e.target.checked&&(document.querySelector('input[name="multidrop"]').checked=!0)})),document.querySelector('input[name="multidrop"]').addEventListener("change",(e=>{e.target.checked||(document.querySelector('input[name="fast_approximation"]').checked=!1)})))</script><button>Run</button><pre class=hidden></pre>